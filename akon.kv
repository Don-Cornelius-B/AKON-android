#:import config config

ScreenManager:
    id: screen_manager
    
    # --- Login / Initialization Screen ---
    Screen:
        name: 'login_screen'
        AnchorLayout:
            canvas.before:
                Color:
                    rgba: config.DARK_SPACE
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            # The Glassmorphism Card
            BoxLayout:
                orientation: 'vertical'
                size_hint: 0.85, None
                height: 300
                padding: 30
                spacing: 20
                canvas.before:
                    Color:
                        rgba: 1, 1, 1, 0.05 # Translucent overlay
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20,]
                    Color:
                        rgba: config.CYBER_BLUE
                    Line:
                        width: 1.2
                        rounded_rectangle: (self.x, self.y, self.width, self.height, 20)

                Label:
                    text: "AKON IDENTITY"
                    font_size: '22sp'
                    bold: True
                    color: config.CYBER_BLUE

                TextInput:
                    id: user_id_input
                    hint_text: "Enter Node ID..."
                    multiline: False
                    write_tab: False
                    padding: [10, 10]
                    background_color: 1, 1, 1, 0.1
                    foreground_color: 1, 1, 1, 1

                Button:
                    text: "INITIALIZE NODE"
                    bold: True
                    background_normal: ''
                    background_color: config.CYBER_BLUE
                    on_release: app.start_session(user_id_input.text)

    # --- Main Chat / Mesh Screen ---
    Screen:
        name: 'chat_screen'
        BoxLayout:
            orientation: 'vertical'
            canvas.before:
                Color:
                    rgba: config.DARK_SPACE
                Rectangle:
                    pos: self.pos
                    size: self.size

            # Header Bar
            BoxLayout:
                size_hint_y: 0.1
                padding: [15, 0]
                canvas.before:
                    Color:
                        rgba: 1, 1, 1, 0.02
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Label:
                    text: "AKON AGNOSTIC MESH"
                    bold: True
                    color: config.CYBER_BLUE
                    halign: 'left'
                    text_size: self.width, None

            # Chat History Area
            ScrollView:
                id: scroll_view
                size_hint_y: 0.8
                BoxLayout:
                    id: chat_list
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: [15, 15]
                    spacing: 15

            # Bottom Input Bar
            BoxLayout:
                size_hint_y: 0.1
                padding: 10
                spacing: 10
                canvas.before:
                    Color:
                        rgba: 1, 1, 1, 0.05
                    Rectangle:
                        pos: self.pos
                        size: self.size
                
                TextInput:
                    id: msg_input
                    hint_text: "Shout to mesh..."
                    multiline: False
                    write_tab: False
                
                Button:
                    text: "SHOUT"
                    size_hint_x: 0.25
                    bold: True
                    background_normal: ''
                    background_color: config.CYBER_BLUE
                    on_release: app.send_broadcast(msg_input)

# --- Templates for Custom Widgets ---

<MessageBubble>:
    orientation: 'vertical'
    size_hint: 0.75, None
    height: self.minimum_height
    padding: [12, 10]
    # Anchors bubbles to right if 'is_me' is true, else left
    pos_hint: {'right': 1} if self.is_me else {'left': 1}
    
    canvas.before:
        Color:
            rgba: config.MY_BUBBLE if self.is_me else config.THEIR_BUBBLE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            # Dynamic tail logic: bottom-right sharp for me, bottom-left sharp for others
            radius: [15, 15, (0, 15) if self.is_me else (15, 0), 15]

    Label:
        text: "[b]" + root.sender + "[/b]  [size=12]" + root.time + "[/size]"
        markup: True
        size_hint_y: None
        height: 20
        halign: 'left'
        text_size: self.width, None
        color: config.TEXT_LIGHT

    Label:
        text: root.message
        size_hint_y: None
        height: self.texture_size[1]
        text_size: self.width, None
        halign: 'left'
        valign: 'top'
        color: config.TEXT_LIGHT